# ===================================
# External Secrets - Production Configuration
# ===================================
# Prerequisites:
# 1. External Secrets Operator installed in the cluster
# 2. A SecretStore or ClusterSecretStore configured for your backend
#    (Vault, AWS Secrets Manager, Azure Key Vault, etc.)
#
# The actual SecretStore should be created by platform team or in a
# separate bootstrap process.

---
# ===================================
# ExternalSecret for application secrets
# ===================================
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: realtime-poll-secrets
  labels:
    app.kubernetes.io/name: realtime-poll
spec:
  # How often to sync secrets
  refreshInterval: 1h
  
  # Reference to the SecretStore
  secretStoreRef:
    name: cluster-secret-store  # Change to your ClusterSecretStore name
    kind: ClusterSecretStore
  
  # Target Kubernetes Secret
  target:
    name: realtime-poll-secrets
    creationPolicy: Owner
    template:
      type: Opaque
      metadata:
        labels:
          app.kubernetes.io/name: realtime-poll
  
  # Data mappings from external secret store
  data:
    - secretKey: REDIS_PASSWORD
      remoteRef:
        key: realtime-poll/secrets  # Path in your secret store
        property: redis-password
    
    - secretKey: SESSION_SECRET
      remoteRef:
        key: realtime-poll/secrets
        property: session-secret

---
# ===================================
# Example: ClusterSecretStore for HashiCorp Vault
# ===================================
# Uncomment and configure based on your setup
#
# apiVersion: external-secrets.io/v1beta1
# kind: ClusterSecretStore
# metadata:
#   name: cluster-secret-store
# spec:
#   provider:
#     vault:
#       server: "https://vault.example.com"
#       path: "secret"
#       version: "v2"
#       auth:
#         kubernetes:
#           mountPath: "kubernetes"
#           role: "external-secrets"
#           serviceAccountRef:
#             name: external-secrets
#             namespace: external-secrets

---
# ===================================
# Example: ClusterSecretStore for AWS Secrets Manager
# ===================================
# apiVersion: external-secrets.io/v1beta1
# kind: ClusterSecretStore
# metadata:
#   name: cluster-secret-store
# spec:
#   provider:
#     aws:
#       service: SecretsManager
#       region: eu-west-1
#       auth:
#         jwt:
#           serviceAccountRef:
#             name: external-secrets
#             namespace: external-secrets

---
# ===================================
# Example: ClusterSecretStore for Azure Key Vault
# ===================================
# apiVersion: external-secrets.io/v1beta1
# kind: ClusterSecretStore
# metadata:
#   name: cluster-secret-store
# spec:
#   provider:
#     azurekv:
#       authType: ManagedIdentity
#       vaultUrl: "https://your-keyvault.vault.azure.net"
